import HtmlToJson from"./utils/html2json";import showdown from"./utils/showdown.js";import{getSystemInfo,bindInstance}from"./utils/util";Component({properties:{nodes:{type:null,observer(t){const{language:e}=this.properties;if(t&&("html"===e&&this._parseNodes(t),"markdown"===e||"md"===e)){const e=(new showdown.Converter).makeHtml(t);this._parseNodes(e)}}},language:{type:String,value:"html"}},data:{nodesData:[],bindData:{}},detached(){bindInstance.clear()},methods:{_parseHtml(t,e){const a=HtmlToJson.html2json(t,"wxParseData");a.view={},a.view.imagePadding=0,this.setData({nodesData:a.nodes,bindData:{wxParseData:a}}),bindInstance.set("wxParseData",a),console.log(this.data)},_parseNodes(t){if("string"==typeof t)this._parseHtml(t);else if(Array.isArray(t))this.setData({nodesData:t});else{const e=[t];this.setData({nodesData:e})}},wxParseImgLoad(t){const{from:e,index:a}=t.target.dataset||{};if(void 0!==e&&e.length>0){const{width:e,height:s}=t.detail,n=this._wxAutoImageCal(e,s);this.setData({width:n.imageWidth,height:n.imageHeight,[`nodesData[${a}].loaded`]:!0})}},wxParseImgTap(t){const{src:e}=t.target.dataset,{imageUrls:a}=bindInstance.set("wxParseData");wx.previewImage({current:e,urls:a})},_wxAutoImageCal(t,e){let a=0,s=0;const n={},[i,o]=getSystemInfo();return t>i?(a=i,s=a*e/t,n.imageWidth=a,n.imageHeight=s):(n.imageWidth=t,n.imageHeight=e),n},wxParseTagATap(t){const{src:e=""}=t.currentTarget.dataset,a=getCurrentPages(),s=a[a.length-1];if(s&&s.handleTagATap)return void s.handleTagATap(e);-1===e.indexOf("http")?wx.navigateTo({url:e}):wx.navigateTo({url:"/components/wxParse/webviewPage/webviewPage?src="+e})}}});